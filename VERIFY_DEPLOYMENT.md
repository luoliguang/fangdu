# ğŸ” éƒ¨ç½²éªŒè¯æŒ‡å—

## æœ€å¿«é€Ÿçš„éªŒè¯æ–¹æ³•ï¼ˆæ¨èï¼‰â­

### æ–¹æ³• 1ï¼šæµè§ˆå™¨ Network æ£€æŸ¥ï¼ˆæœ€ç›´è§‚ï¼‰

1. **æ‰“å¼€æ‚¨çš„ç½‘ç«™**
   - è®¿é—®ï¼š`http://your-domain.com` æˆ– `http://your-server-ip`

2. **æ‰“å¼€å¼€å‘è€…å·¥å…·**
   - æŒ‰ `F12` é”®
   - æˆ–å³é”® â†’ æ£€æŸ¥

3. **åˆ‡æ¢åˆ° Network æ ‡ç­¾**
   - ç‚¹å‡»é¡¶éƒ¨çš„ "Network" (ç½‘ç»œ) æ ‡ç­¾
   - å‹¾é€‰ "Preserve log" (ä¿ç•™æ—¥å¿—)

4. **åˆ·æ–°é¡µé¢**
   - æŒ‰ `F5` æˆ– `Ctrl+R`

5. **æŸ¥æ‰¾å¿ƒè·³è¯·æ±‚**
   - åœ¨ç­›é€‰æ¡†è¾“å…¥ `heartbeat`
   - åº”è¯¥çœ‹åˆ°ï¼š
     - âœ… `POST /api/v1/visits/heartbeat` è¯·æ±‚
     - âœ… æ¯ 30 ç§’è‡ªåŠ¨å‘é€ä¸€æ¬¡
     - âœ… çŠ¶æ€ç ï¼š200 OK
     - âœ… å“åº”ï¼š`{"success":true,"message":"å¿ƒè·³æ›´æ–°æˆåŠŸ"}`

6. **æŸ¥æ‰¾è®¿é—®è®°å½•è¯·æ±‚**
   - åœ¨ç­›é€‰æ¡†è¾“å…¥ `record`
   - åº”è¯¥çœ‹åˆ°ï¼š
     - âœ… `POST /api/v1/visits/record` è¯·æ±‚
     - âœ… åˆ‡æ¢é¡µé¢æ—¶å‘é€
     - âœ… çŠ¶æ€ç ï¼š200 OK

7. **æµ‹è¯•ç¦»çº¿é€šçŸ¥**
   - å…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µ
   - åº”è¯¥çœ‹åˆ°ï¼š
     - âœ… `POST /api/v1/visits/offline` è¯·æ±‚ï¼ˆå¯èƒ½å¾ˆå¿«ï¼Œéœ€è¦ä»”ç»†çœ‹ï¼‰

**ç»“æœåˆ¤æ–­ï¼š**
- âœ… å¦‚æœçœ‹åˆ°è¿™äº›è¯·æ±‚ â†’ **éƒ¨ç½²æˆåŠŸï¼æ–°åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼**
- âŒ å¦‚æœæ²¡æœ‰çœ‹åˆ° â†’ ç»§ç»­æŸ¥çœ‹ä¸‹é¢çš„æ•…éšœæ’é™¤

---

### æ–¹æ³• 2ï¼šç®¡ç†åå°ç»Ÿè®¡ï¼ˆéªŒè¯åŠŸèƒ½ï¼‰

1. **ç™»å½•ç®¡ç†åå°**
   - è®¿é—®ï¼š`http://your-domain.com/admin`
   - è¾“å…¥ç®¡ç†å‘˜è´¦å·å¯†ç 

2. **è¿›å…¥ç»Ÿè®¡é¡µé¢**
   - ç‚¹å‡»å·¦ä¾§èœå• "ç»Ÿè®¡åˆ†æ"

3. **æŸ¥çœ‹åœ¨çº¿äººæ•°**
   - æ‰¾åˆ° "å½“å‰åœ¨çº¿" æŒ‡æ ‡
   - è®°ä¸‹æ•°å­—ï¼ˆä¾‹å¦‚ï¼š1ï¼‰

4. **æµ‹è¯•å¤šæµè§ˆå™¨**
   - ç”¨å¦ä¸€ä¸ªæµè§ˆå™¨æ‰“å¼€ç½‘ç«™ï¼ˆä¾‹å¦‚ Chrome â†’ Edgeï¼‰
   - åˆ·æ–°ç®¡ç†åå°ç»Ÿè®¡é¡µé¢
   - åœ¨çº¿äººæ•°åº”è¯¥å¢åŠ ï¼ˆä¾‹å¦‚ï¼š1 â†’ 2ï¼‰

5. **æµ‹è¯•æµè§ˆå™¨å…³é—­**
   - å…³é—­æ–°æ‰“å¼€çš„æµè§ˆå™¨
   - ç­‰å¾… 1-2 åˆ†é’Ÿ
   - åˆ·æ–°ç®¡ç†åå°ç»Ÿè®¡é¡µé¢
   - åœ¨çº¿äººæ•°åº”è¯¥å‡å°‘ï¼ˆä¾‹å¦‚ï¼š2 â†’ 1ï¼‰

**ç»“æœåˆ¤æ–­ï¼š**
- âœ… åœ¨çº¿äººæ•°éšæµè§ˆå™¨å¼€å…³å˜åŒ– â†’ **æ–°åŠŸèƒ½å·¥ä½œæ­£å¸¸ï¼**
- âŒ åœ¨çº¿äººæ•°ä¸å˜æˆ–ä¸å‡†ç¡® â†’ ç»§ç»­æŸ¥çœ‹æ•…éšœæ’é™¤

---

## æœåŠ¡å™¨ç«¯éªŒè¯

### æ–¹æ³• 3ï¼šæ£€æŸ¥ä»£ç ç‰ˆæœ¬

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh user@your-server

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/fangdu

# æŸ¥çœ‹æœ€æ–°æäº¤
git log -1 --oneline
```

**åº”è¯¥æ˜¾ç¤ºï¼š**
```
bd24fb7 feat: ä¼˜åŒ–åœ¨çº¿ç»Ÿè®¡ç³»ç»Ÿå¹¶æ¸…ç†é¡¹ç›® (v1.5.2)
```

å¦‚æœä¸æ˜¯è¿™ä¸ªç‰ˆæœ¬ï¼š
```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# è¿è¡Œéƒ¨ç½²è„šæœ¬
./deploy.sh
```

---

### æ–¹æ³• 4ï¼šæ£€æŸ¥æ•°æ®åº“è¡¨

```bash
# è¿›å…¥æ•°æ®åº“ç›®å½•
cd backend/database

# æŸ¥çœ‹æ‰€æœ‰è¡¨
sqlite3 my_materials.db "SELECT name FROM sqlite_master WHERE type='table';"
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
materials
feedbacks
visits
online_sessions  â† è¿™æ˜¯æ–°è¡¨ï¼
```

å¦‚æœæ²¡æœ‰ `online_sessions` è¡¨ï¼š
```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
cd /path/to/fangdu
node backend/scripts/migrate-add-online-sessions.js
```

---

### æ–¹æ³• 5ï¼šæµ‹è¯•å¿ƒè·³ API

```bash
# æµ‹è¯•å¿ƒè·³æ¥å£
curl -X POST http://localhost:3002/api/v1/visits/heartbeat \
  -H "Content-Type: application/json" \
  -d '{"sessionId": "test123"}'
```

**åº”è¯¥è¿”å›ï¼š**
```json
{"success":true,"message":"å¿ƒè·³æ›´æ–°æˆåŠŸ"}
```

---

### æ–¹æ³• 6ï¼šæŸ¥çœ‹åœ¨çº¿ä¼šè¯

```bash
# æŸ¥çœ‹å½“å‰åœ¨çº¿ä¼šè¯
cd /path/to/fangdu/backend/database
sqlite3 my_materials.db "SELECT session_id, datetime(last_heartbeat, 'localtime') as last_beat FROM online_sessions ORDER BY last_heartbeat DESC LIMIT 5;"
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
session_1728123456789_abc|2024-10-08 18:30:45
session_1728123456790_def|2024-10-08 18:30:15
```

---

## è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬

### Windows (PowerShell)

```powershell
# è¿è¡Œæ£€æŸ¥è„šæœ¬
.\check-deployment.ps1
```

### Linux/macOS

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x check-deployment.sh

# è¿è¡Œæ£€æŸ¥è„šæœ¬
./check-deployment.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š
- âœ… Git ç‰ˆæœ¬
- âœ… æ•°æ®åº“è¡¨ç»“æ„
- âœ… æœåŠ¡è¿è¡ŒçŠ¶æ€
- âœ… API æ¥å£
- âœ… å‰ç«¯ä»£ç 

---

## æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šæµè§ˆå™¨æ²¡æœ‰çœ‹åˆ° heartbeat è¯·æ±‚

**å¯èƒ½åŸå› ï¼š**
- å‰ç«¯ä»£ç æœªæ›´æ–°
- æµè§ˆå™¨ç¼“å­˜äº†æ—§ä»£ç 

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æœåŠ¡å™¨ä¸Š
cd /path/to/fangdu
git pull origin main
./deploy.sh

# æµè§ˆå™¨ä¸­
æŒ‰ Ctrl+Shift+Delete æ¸…é™¤ç¼“å­˜
æˆ–æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°
```

---

### é—®é¢˜ 2ï¼šAPI è¿”å› 404 æˆ– 500 é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
- åç«¯ä»£ç æœªæ›´æ–°
- æœåŠ¡æœªé‡å¯

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æœåŠ¡å™¨ä¸Š
cd /path/to/fangdu
git pull origin main

# é‡å¯æœåŠ¡
pm2 restart fangdu-backend

# æˆ–è€…
./deploy.sh
```

---

### é—®é¢˜ 3ï¼šåœ¨çº¿äººæ•°å§‹ç»ˆæ˜¯ 0

**å¯èƒ½åŸå› ï¼š**
- `online_sessions` è¡¨ä¸å­˜åœ¨
- å¿ƒè·³æœºåˆ¶æœªå¯åŠ¨

**è§£å†³æ–¹æ³•ï¼š**
```bash
# 1. æ£€æŸ¥æ•°æ®åº“è¡¨
cd /path/to/fangdu/backend/database
sqlite3 my_materials.db "SELECT name FROM sqlite_master WHERE type='table' AND name='online_sessions';"

# 2. å¦‚æœæ²¡æœ‰ï¼Œè¿è¡Œè¿ç§»
cd /path/to/fangdu
node backend/scripts/migrate-add-online-sessions.js

# 3. é‡å¯æœåŠ¡
pm2 restart fangdu-backend
```

---

### é—®é¢˜ 4ï¼šåœ¨çº¿äººæ•°ä¸å‡†ç¡®

**å¯èƒ½åŸå› ï¼š**
- æµè§ˆå™¨ç¼“å­˜
- å¿ƒè·³æœªæ­£å¸¸å‘é€

**è§£å†³æ–¹æ³•ï¼š**
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. æ‰“å¼€ F12 â†’ Networkï¼Œç¡®è®¤ heartbeat è¯·æ±‚æ¯ 30 ç§’å‘é€ä¸€æ¬¡
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š`pm2 logs fangdu-backend`

---

## éªŒè¯æ¸…å•

éƒ¨ç½²åè¯·ä¾æ¬¡ç¡®è®¤ï¼š

- [ ] ä»£ç ç‰ˆæœ¬æ˜¯ v1.5.2ï¼ˆbd24fb7ï¼‰
- [ ] æ•°æ®åº“ä¸­æœ‰ `online_sessions` è¡¨
- [ ] åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ
- [ ] æµè§ˆå™¨ Network ä¸­å¯ä»¥çœ‹åˆ° heartbeat è¯·æ±‚
- [ ] ç®¡ç†åå°æ˜¾ç¤ºæ­£ç¡®çš„åœ¨çº¿äººæ•°
- [ ] å¤šä¸ªæµè§ˆå™¨æ‰“å¼€æ—¶ï¼Œåœ¨çº¿äººæ•°å¢åŠ 
- [ ] å…³é—­æµè§ˆå™¨å 1-2 åˆ†é’Ÿï¼Œåœ¨çº¿äººæ•°å‡å°‘

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æ›´æ–°ä»£ç 
git pull origin main

# ä¸€é”®éƒ¨ç½²
./deploy.sh

# æ•°æ®åº“è¿ç§»
node backend/scripts/migrate-add-online-sessions.js

# é‡å¯æœåŠ¡
pm2 restart fangdu-backend

# æŸ¥çœ‹æ—¥å¿—
pm2 logs fangdu-backend

# æŸ¥çœ‹åœ¨çº¿ä¼šè¯
sqlite3 backend/database/my_materials.db "SELECT COUNT(*) FROM online_sessions WHERE last_heartbeat >= datetime('now', '-1 minute');"

# æµ‹è¯• API
curl http://localhost:3002/api/v1/visits/online
```

---

**æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š**
1. æµè§ˆå™¨ F12 â†’ Network æ ‡ç­¾
2. PM2 æ—¥å¿—ï¼š`pm2 logs fangdu-backend`
3. æ•°æ®åº“è¡¨ï¼š`sqlite3 backend/database/my_materials.db ".tables"`

