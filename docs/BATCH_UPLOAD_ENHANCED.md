# 批量上传功能增强说明

## 更新日期
2025-10-02

## 更新内容

在原有批量上传功能基础上，新增了**为每个文件单独编辑名称和标签**的功能，使批量上传更加灵活和实用。

## 新增功能

### ✅ 单独编辑每个文件
- 每个文件都可以设置独立的名称
- 每个文件都可以设置独立的标签
- 支持批量应用共享标签
- 实时显示上传状态

### ✅ 智能默认值
- 文件名自动作为默认素材名称
- 共享标签可作为所有文件的默认标签
- 支持一键应用共享标签到所有文件

### ✅ 视觉反馈
- 上传中：蓝色边框 + 加载动画
- 上传成功：绿色边框 + 成功图标
- 上传失败：红色边框 + 错误信息
- 失败文件自动保留，可重新编辑后重试

## 使用方法

### 1. 选择文件

点击"批量上传"，选择多个文件（或拖拽）

### 2. 编辑文件信息

**方式一：单独编辑**
- 每个文件卡片都有"素材名称"和"标签"两个输入框
- 直接修改每个文件的信息

**方式二：批量应用标签**
1. 在顶部"共享标签"输入框填写标签
2. 点击"应用到所有文件"按钮
3. 所有文件的标签字段会被更新

**方式三：混合使用**
1. 先应用共享标签
2. 再单独修改特定文件的标签或名称

### 3. 上传

点击"批量上传"按钮，系统会逐个上传文件：
- 每个文件会显示上传状态
- 上传成功的文件显示绿色
- 上传失败的文件显示红色并保留
- 可以修改失败文件的信息后重新上传

## 界面展示

```
┌──────────────────────────────────────────┐
│  共享标签: [面料,夏季_]  [应用到所有文件]│
├──────────────────────────────────────────┤
│  已选择 3 个文件         [清空所有]      │
├──────────────────────────────────────────┤
│  ┌────────────────────────────────────┐  │
│  │ 🖼️ 产品图1.jpg    2.5 MB     [×] │  │
│  ├────────────────────────────────────┤  │
│  │ 素材名称: [产品图1_________]    │  │
│  │ 标签: [面料,夏季,新款_______]   │  │
│  │ ✓ 上传成功                       │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ 🎬 产品视频.mp4  45.2 MB    [×]  │  │
│  ├────────────────────────────────────┤  │
│  │ 素材名称: [产品展示视频_____]    │  │
│  │ 标签: [视频,产品,展示_______]    │  │
│  │ ⟳ 上传中...                     │  │
│  └────────────────────────────────────┘  │
│                                          │
│  ┌────────────────────────────────────┐  │
│  │ 🖼️ 详情图.png    1.8 MB     [×]  │  │
│  ├────────────────────────────────────┤  │
│  │ 素材名称: [产品详情图_______]    │  │
│  │ 标签: [图片,详情____________]    │  │
│  │ ✗ 文件大小超过限制               │  │
│  └────────────────────────────────────┘  │
│                                          │
│  [批量上传 (3 个文件)]                  │
└──────────────────────────────────────────┘
```

## 主要改进

### 1. 数据结构变化

**之前：**
```javascript
batchFiles = [File, File, File]
```

**现在：**
```javascript
batchFiles = [
  {
    file: File,           // 原始文件对象
    name: '产品图1',       // 可编辑的素材名称
    tags: '面料,夏季',     // 可编辑的标签
    uploading: false,     // 上传状态
    uploaded: false,      // 是否已上传
    error: null          // 错误信息
  },
  ...
]
```

### 2. 上传逻辑变化

**之前：**
- 使用批量上传API (`/batch/upload`)
- 一次性提交所有文件
- 统一的标签

**现在：**
- 使用单个上传API (`/materials`)
- 逐个上传每个文件
- 每个文件独立的名称和标签
- 实时更新每个文件的状态

### 3. 用户体验提升

| 功能 | 之前 | 现在 |
|------|------|------|
| 名称设置 | 自动从文件名生成，不可修改 | 可单独编辑 |
| 标签设置 | 所有文件共享，不可修改 | 可单独编辑 |
| 批量操作 | 不支持 | 支持批量应用标签 |
| 上传状态 | 整体进度条 | 每个文件独立状态 |
| 失败处理 | 显示失败列表 | 保留失败文件，可重新上传 |
| 实时反馈 | 上传完成后统一显示 | 每个文件实时显示状态 |

## 技术实现

### 文件卡片组件

每个文件都是一个独立的卡片，包含：
- 文件信息（图标、文件名、大小）
- 可编辑字段（名称输入框、标签输入框）
- 状态指示器（上传中/成功/失败）
- 移除按钮

### 状态管理

使用Vue的响应式系统追踪每个文件的状态：
- `uploading`: 当前正在上传
- `uploaded`: 已成功上传
- `error`: 上传失败信息

### 批量应用功能

```javascript
const applyTagsToAll = () => {
  if (!batchTags.value.trim()) {
    toast.warning('请先填写共享标签');
    return;
  }
  
  batchFiles.value.forEach(item => {
    item.tags = batchTags.value;
  });
  
  toast.success('已将标签应用到所有文件');
};
```

### 串行上传

```javascript
for (let i = 0; i < batchFiles.value.length; i++) {
  const item = batchFiles.value[i];
  item.uploading = true;
  
  const formData = new FormData();
  formData.append('name', item.name);
  formData.append('tags', item.tags);
  formData.append('file', item.file);
  
  const result = await uploadMaterial(formData);
  
  if (result.success) {
    item.uploaded = true;
  } else {
    item.error = result.message;
  }
  
  item.uploading = false;
}
```

## 使用场景

### 场景1：统一标签，不同名称

上传一批产品图片，标签都是"产品,夏季"，但需要不同的名称：

1. 填写共享标签："产品,夏季"
2. 点击"应用到所有文件"
3. 单独修改每个文件的名称

### 场景2：不同标签，不同名称

上传混合素材，每个都需要独特的信息：

1. 不使用共享标签
2. 直接在每个文件卡片中填写名称和标签

### 场景3：部分失败重传

批量上传时部分文件失败：

1. 成功的文件自动从列表移除
2. 失败的文件保留在列表中
3. 修改失败文件的信息（如压缩文件大小）
4. 再次点击上传，只上传剩余文件

## 验证规则

### 上传前验证
- 每个文件必须有名称（不能为空）
- 每个文件必须有标签（不能为空）
- 如果任何文件验证失败，显示错误提示

### 实时验证
- 名称为空时输入框显示红色边框
- 标签为空时输入框显示红色边框
- 已上传的文件输入框禁用（灰色）

## 响应式设计

### 桌面端（>768px）
- 名称和标签并排显示（2列布局）
- 文件卡片宽度自适应
- 共享标签和应用按钮在同一行

### 移动端（≤768px）
- 名称和标签上下排列（1列布局）
- 文件信息可能换行显示
- 共享标签和应用按钮上下排列
- 按钮占满宽度

## 性能优化

### 1. 虚拟滚动
如果文件数量超过50个，考虑实现虚拟滚动：
- 只渲染可见区域的文件卡片
- 减少DOM元素数量
- 提升渲染性能

### 2. 防抖输入
输入框修改时可添加防抖：
- 避免频繁更新导致的性能问题
- 特别是在文件数量较多时

### 3. 懒加载
大量文件时，可以分批加载：
- 首次只加载前20个文件卡片
- 滚动到底部时加载更多

## 注意事项

### 1. 数据校验
- 前端校验：每个文件的名称和标签不能为空
- 后端校验：服务器端也会验证数据

### 2. 内存管理
- 大量文件可能占用较多内存
- 建议单次上传不超过20个文件
- 上传成功后及时清理

### 3. 错误处理
- 网络错误：提示用户检查网络
- 文件过大：提示用户压缩文件
- 格式不支持：提示用户转换格式

## 未来改进

### 1. 拖拽排序
支持拖拽调整文件上传顺序

### 2. Excel导入
支持从Excel导入文件信息：
- 文件名 -> 素材名称映射
- 批量设置标签

### 3. 模板功能
保存常用的标签组合作为模板：
- 快速应用预设标签
- 提高录入效率

### 4. 批量编辑
选中多个文件，批量修改信息：
- 批量修改名称（添加前缀/后缀）
- 批量修改标签（添加/替换）

## 文件变更

- ✅ `frontend/src/views/UploadMaterial.vue` - 完整重构批量上传UI
- ✅ 数据结构：简单文件数组 → 包含元数据的对象数组
- ✅ 上传逻辑：批量API → 单个API串行上传
- ✅ 新增功能：批量应用标签
- ✅ 响应式样式：完整的移动端适配

## 相关文档
- [批量上传基础功能](./BATCH_UPLOAD_FEATURE.md)
- [文件上传大小限制](./UPLOAD_SIZE_LIMIT.md)
- [视频封面修复文档](./VIDEO_POSTER_FIX.md)

## 修复完成
✅ 所有增强功能已实现并测试 